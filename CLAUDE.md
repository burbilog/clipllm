# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Important Guidelines

**DO NOT create git commits unless explicitly requested by the user.**

After making code changes, build the project to verify everything compiles, but wait for explicit user approval before committing.

## Project Overview

ClipLLM is a cross-platform LLM clipboard utility written in C++ using Qt6. It runs as a system tray service and allows users to process clipboard content (text and images) with AI prompts using global hotkeys.

**Key Statistics:** ~7,000+ lines of C++17 code across 3 modules (core, ui, models).

## Build Commands

### Linux Native Build

```bash
make build          # Build the project (creates build/, runs cmake, compiles)
make translations   # Update translation files using update-translations.sh
make clean          # Remove build directory
```

### Windows Cross-Compilation (from Linux)

**Requirements:** MXE (M Cross Environment) installed with Qt6

```bash
# Build for Windows (shared by default - recommended for installer)
make windows

# Build static binary (no DLL dependencies, larger file)
make windows MXE_BUILD_TYPE=static

# Deploy Windows build with DLLs and plugins
make windows-deploy

# Create Windows installer (requires Qt Installer Framework in MXE)
make windows-installer

# Test with Wine
make test-windows-wine
```

**MXE Installation:**
```bash
# Clone MXE
git clone https://github.com/mxe/mxe.git ~/mxe
cd ~/mxe

# Build Qt6 for Windows (shared - recommended, ~1-2 hours)
make -j$(nproc) MXE_TARGETS='x86_64-w64-mingw32.shared' qt6

# Or build static (larger binaries, no DLLs needed)
make -j$(nproc) MXE_TARGETS='x86_64-w64-mingw32.static' qt6

# Optional: Build Qt Installer Framework for installers
make -j$(nproc) MXE_TARGETS='x86_64-w64-mingw32.shared' qtifw
```

**MXE Build Types:**
- `shared` (default) - Dynamic linking, requires DLL deployment, smaller exe, supports installer creation
- `static` - Static linking, standalone exe, larger file, installer creation problematic

### Standard Build (manual)

**Build directory:** `build/` in project root

```bash
cd build
cmake ..
make -j$(nproc)
```

### Install (Linux)
```bash
sudo make install
```

### Translation Management
```bash
make translations   # Update all translations from source code
./update-translations.sh    # Same as make translations
linguist translations/*.ts  # Edit translations in Qt Linguist
```

### Web Landing Page
```bash
make web            # Generate docs/index.html from docs/index.html.in
```

**IMPORTANT:** The landing page at `docs/index.html` is **auto-generated**. Follow these rules:

1. **Source file:** Edit `docs/index.html.in` (the template)
2. **Generated file:** `docs/index.html` is created by `make web`
3. **Version:** The `@VERSION@` placeholder is replaced from `CMakeLists.txt`
4. **Logo:** `art/clipllm_hires.png` is copied to `docs/clipllm_hires.png`
5. **Run `make web`** after:
   - Editing `docs/index.html.in`
   - Changing version in `CMakeLists.txt`
   - Updating `art/clipllm_hires.png`

**NEVER edit `docs/index.html` directly** — changes will be lost on next `make web`.

**The generated file contains a warning header:** `<!-- DO NOT EDIT THIS FILE DIRECTLY! ... -->`

**Note:** Both `docs/index.html.in` (template) and `docs/index.html` (generated) are committed to the repository for GitHub Pages. When editing, always modify `.in` and run `make web`.

### Clean Build
```bash
make clean          # Remove all build directories (including Windows)
```

## Architecture

### Namespace Structure

The codebase is organized into three namespaces under `ClipLLM`:

- **`ClipLLM::Core`** - Core business logic (clipboard, LLM client, prompts, config, keychain, history)
- **`ClipLLM::Models`** - Data structures (Prompt, LLMConfig, HistoryEntry)
- **`ClipLLM::UI`** - User interface components (tray icon, dialogs, menus)

### Application Flow (src/core/app.h)

The `App` class (inherits `QApplication`) is the central controller that:

1. Enforces single-instance application
2. Initializes and manages lifecycle of all core components
3. Coordinates signal/slot communication between components
4. Manages translations/i18n
5. Provides access to UI dialogs (settings, history)

**Managed Components:**
- `ClipboardManager` - Monitors system clipboard for text/images
- `LLMClient` - HTTP client with SSE streaming support
- `PromptManager` - CRUD operations for prompts
- `ConfigManager` - QSettings wrapper for configuration
- `KeychainStore` - Platform keychain for API keys
- `HistoryManager` - Request history and statistics
- `TrayIcon` - System tray integration

### Core Module Details

**ClipboardManager** (src/core/clipboardmanager.h)
- Uses Qt's `QApplication::clipboard()`
- Supports text, HTML, and image content
- Base64-encodes images for vision models

**LLMClient** (src/core/llmclient.h)
- State machine: Idle → Connecting → Streaming → Completed/Error
- Server-Sent Events (SSE) streaming with real-time parsing
- Supports OpenRouter, OpenAI, Anthropic, and custom endpoints
- Provider-specific response parsing required for streaming

**PromptManager** (src/core/promptmanager.h)
- Loads prompts from `~/.config/ClipLLM/prompts.json` or bundled defaults
- Template format: `{clipboard}` placeholder in user prompt templates

**ConfigManager** (src/core/configmanager.h)
- Platform-agnostic storage via QSettings:
  - Linux: `~/.config/ClipLLM/ClipLLM.conf`
  - Windows: Registry `HKEY_CURRENT_USER\Software\ClipLLM`
  - macOS: `~/Library/Preferences/com.ClipLLM.plist`

**KeychainStore** (src/core/keychainstore.h)
- Platform-specific secure credential storage:
  - Linux: libsecret (GNOME Keyring) / KWallet
  - Windows: Windows Credential Manager
  - macOS: Keychain Services

### Data Models (src/models/)

- **Prompt**: `id`, `name`, `systemPrompt`, `userPromptTemplate`, `contentType` (Text/Image/Any), `model`, `icon`, `temperature`, `maxTokens`, `enabled`, `priority`, `overrideTemperature`, `metadata`
- **LLMConfig**: `provider` (enum), `apiKey`, `model`, `apiUrl`, `temperature`, `maxTokens`, `topP`, `stream`, `proxyUrl`, `timeoutSeconds`
- **HistoryEntry**: `id`, `promptId`, `timestamp`, `contentType`, input/output text, base64 images, token counts, duration, favorite, tags

### UI Components (src/ui/)

- **TrayIcon**: System tray with context menu, dynamic prompt generation
- **SettingsDialog**: 5-tab interface (General, LLM, Hotkeys, Prompts, History)
- **ResultDialog**: Real-time streaming display with Markdown/Raw toggle
- **HotkeyEdit**: Custom widget for hotkey capture
- **HistoryDialog**: Searchable history viewer with Markdown/Raw preview and export
- **PromptEditorDialog**: Full UI for creating and editing prompts

## Configuration Files

- **Default Prompts**: `resources/config/prompts-default.json` (16 built-in prompts)
- **Qt Resources**: `resources/resources.qrc` - bundles prompts and icons into executable
- **Desktop Entry**: `resources/clipllm.desktop.in` - Linux application launcher

## Platform-Specific Notes

### Linux
- **Dependencies**: `qt6-base-dev`, `qt6-tools-dev`, `cmake`, `build-essential`
- **X11**: Full functionality including global hotkeys
- **Wayland**: System tray works, global hotkeys have limitations

### Windows (Cross-compiled from Linux)
- **Build Method**: MXE (M Cross Environment) cross-compilation
- **Build Types**: `shared` (default, requires DLLs) or `static` (standalone)
- **Toolchain**: `cmake/windows-x86_64-mingw.cmake` with MXE wrappers
- **Full Functionality**: All features supported including system tray and global hotkeys
- **Installer**: Qt Installer Framework support via `make windows-installer`
- **See Also**: Windows Cross-Compilation section above for build details

### macOS
- Qt6 via Homebrew: `brew install qt@6`
- Full functionality supported

## Version Management

**Single Source of Truth:** The application version is defined in ONE place:

### CMakeLists.txt (line ~18)
```cmake
project(ClipLLM VERSION 1.0.0 LANGUAGES CXX)
```

When you change the version here:
- CMake automatically generates `build/src/core/version.h`
- All code can include `core/version.h` to access version macros:
  - `CLIPAI_VERSION_MAJOR`, `CLIPAI_VERSION_MINOR`, `CLIPAI_VERSION_PATCH`
  - `CLIPAI_VERSION_STR` - full version string (e.g., "1.0.0")
  - `ClipLLM::versionString()` - Qt function returning version QString
- **Run `make web`** to update the version on the landing page

**Example usage in code:**
```cpp
#include "core/version.h"

QString version = ClipLLM::versionString();  // "1.0.0"
```

**Never edit** `build/src/core/version.h` directly - it will be overwritten on rebuild.

## Adding New Features

### Adding a New LLM Provider
1. Add to `LLMProvider` enum in `models/llmconfig.h`
2. Update `LLMConfig::createDefault()` and `availableModels()`
3. Add provider-specific streaming parsing in `llmclient.cpp`
4. Update Settings dialog provider dropdown

### Adding a New Prompt
1. Edit `~/.config/ClipLLM/prompts.json` directly, or
2. Use the Settings → Prompts tab with full prompt editor UI
3. Required fields: `id`, `name`, `system_prompt`, `user_prompt_template`, `content_type`, `enabled`
4. Optional: `priority` (higher = appears first in menu), `description`, `icon`

### Adding a New Language
1. Create `translations/clipllm_xx.ts`
2. Run `lupdate src/ -ts translations/clipllm_xx.ts`
3. Edit with Qt Linguist
4. Add to `TS_FILES` in CMakeLists.txt
5. Update Settings language dropdown


## Reference implementation

Directory ai-reader/ contains old reference implementation of this program. Read it
only if I reference previous, python incarnation of this program.

## Known Limitations

- **No CI/CD**: No GitHub Actions or other CI configuration

## Dependencies

- **Qt6**: Core, Widgets, Network, LinguistTools
- **Optional**: Qt6::Concurrent (for async operations)
- **Build**: CMake 3.16+, C++17 compiler
